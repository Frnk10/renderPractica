{% extends "plantilla.html" %}
{% block body %}
    <br>
    <h1 class="text-center">GESTIÓN DE DIRECTORES CON AXIOS</h1>
    <!-- Button trigger modal -->
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-end">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#directorModal">
                <i class="fas fa-plus"></i>
                    Agregar Director Axios
                </button>
                <a href="{% url 'nuevoDirector' %}" class="btn btn-success">Agregar Director</a>
            </div>
            <br>
            <div class="col-md-12" id="contenedor-directores"></div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="directorModal" tabindex="-1" aria-labelledby="directorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="directorModalLabel">DATOS DEL NUEVO DIRECTOR</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="#" id="frm_nuevo_director" enctype="multipart/form-data">
                        <label for=""><b>APELLIDO:</b></label>
                        <input type="text" name="apellido" class="form-control" id="apellido" placeholder="Ingrese el apellido del director">
                        <br>
                        <label for=""><b>NOMBRE:</b></label>
                        <input name="nombre" id="nombre" class="form-control" rows="3" placeholder="Ingrese el nombre del director">
                        <br>
                        <label for=""><b>ESTADO:</b></label>
                        <input type="checkbox" name="estado" id="estado">
                        <br><br>
                        <label for=""><b>FOTO:</b></label>
                        <input type="file" name="foto" id="foto"
                        accept="image/*" required class="form-control">
                        <br><br>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                                Guardar
                            </button>
                            <button type="reset" class="btn btn-danger" data-bs-dismiss="modal">
                                <i class="fas fa-times"></i>
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <br><br><br><br><br><br>
    <!--CODIGO PARA VALIDAR-->
    <script>
        $("#frm_nuevo_director").validate({
            rules:{
                apellido:{
                    required:true,
                },
                nombre:{
                    required:true,
                },
                foto:{
                    required:true,
                }
            },
            messages:{
                apellido:{
                    required:"Por favor, ingrese el dato solicitado",
                },
                nombre:{
                    required:"Por favor, ingrese el dato solicitado"
                },
                foto:{
                    required:"Por favor, seleccione una foto",
                }
            }            
        });
        //METODO FETCH

        // Funcion para obtener el token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        document.getElementById('frm_nuevo_director').addEventListener('submit', function(event){
            event.preventDefault();

            const formData = new FormData(this);

            axios.post('/agregarDirectorAxios/', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                const data = response.data;
                if (data.estado) {
                    Swal.fire({
                        title: "CONFIRMACIÓN",
                        text: data.mensaje,
                        icon: 'success'
                    });
                    $('#directorModal').modal('hide'); // Ocultar el modal
                    this.reset(); // Resetear el formulario actual (frm_nuevo_director)
                    cargarDirectores(); // Cargar listado de directores después de insertar
                } else {
                    Swal.fire({
                        title: "ERROR",
                        text: "Error al guardar los datos",
                        icon: 'error'
                    });
                }
            })
            .catch(error => {
                console.error('Axios Error:', error);
                Swal.fire({
                    title: "ERROR",
                    text: "Ocurrió un error al procesar la solicitud",
                    icon: 'error'
                });
            });
        });     
        //Funcion para cargar el listado de Directores con Fetch
        function cargarDirectores() {
            fetch('{% url "listadoDirectores" %}')
            .then(response => response.text())
            .then(data => {
                document.getElementById('contenedor-directores').innerHTML = data;
                let table = new DataTable('#tbl-director'); // Inicializar DataTable si es necesario
            })
            .catch(error => {
                console.error('Error al cargar lista de directores:', error);
            });
        }
        cargarDirectores();
    </script>
{% endblock %}